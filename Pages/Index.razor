@page "/"
@using System.Security.Cryptography.X509Certificates
@using MetamaskDecryption.Data
@inject IJSRuntime Javascript
@inject EthereumService Ethereum

@if (!loggedIn)
{
    @if (metamaskIsInstalled)
    {
        <button @onclick="MetaMaskSignInAsync">Sign In With Metamask</button>
        <h3 @bind="error"></h3>
    }
    else
    {
        <h3>Metamask is not installed in this browser</h3>
    }
}
else
{
    <h1>Hello @metamaskId!</h1>
    <input @bind="input"/>
    <button @onclick="Encrypt">Encrypt Message</button>
    <h1>Encrypted Text: @encryptedText</h1>
    <button @onclick="Decrypt">Decrypt Message</button>
    <h1>Decrypted Text: @decryptedText</h1>
}
@code
{
    private string error;
    private string metamaskId;
    private string input;
    private bool metamaskIsInstalled;
    private bool loggedIn;
    private string encryptedText;
    private string decryptedText;
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        metamaskIsInstalled = await Javascript.InvokeAsync<bool>("JsLib.metamaskIsInstalled");
        metamaskIsInstalled = await Javascript.InvokeAsync<bool>("JsLib.metamaskIsInstalled");
        StateHasChanged();
    }

    private async Task Encrypt()
    {
        var publicKey = await Ethereum.GetPublicKeyAsync(metamaskId);
        var result = await Javascript.InvokeAsync<EncryptionResult>("JsLib.encryptMessage", publicKey, input);
        encryptedText = result.ciphertext;
    }

    private async Task Decrypt()
    {
        decryptedText = await Javascript.InvokeAsync<string>("JsLib.decryptAsync", encryptedText);
    }

    // DTO returned by JS method
    public record EncryptionResult(string ciphertext, string ephemPublicKey, string nonce, string version);

    private async Task MetaMaskSignInAsync()
    {
        try
        {
            metamaskId = await Javascript.InvokeAsync<string>("JsLib.loginAsync");
            loggedIn = true;
        }
        catch (Exception)
        {
            error = "Could not log in with MetaMask. Is your MetaMask unlocked?";
        }
    }

}